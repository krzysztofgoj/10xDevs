{% extends 'base.html.twig' %}

{% block title %}Moje fiszki - 10x Cards{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .flashcard-item {
        transition: all 0.2s ease;
    }
    .flashcard-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem 0 rgba(0, 0, 0, 0.15) !important;
    }
    .flashcard-front, .flashcard-back {
        min-height: 60px;
    }
    .badge-source {
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block body %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="text-white mb-0">
                    <i class="bi bi-collection"></i> Moje fiszki
                </h1>
                <div>
                    <a href="{{ path('flashcards_learn_start') }}" class="btn btn-success me-2">
                        <i class="bi bi-brain"></i> Rozpocznij naukę
                    </a>
                    <a href="{{ path('flashcards_add') }}" class="btn btn-light">
                        <i class="bi bi-plus-circle"></i> Dodaj fiszkę
                    </a>
                </div>
            </div>

            <!-- Loading State -->
            <div class="card mb-4" id="loadingCard">
                <div class="card-body text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Ładowanie...</span>
                    </div>
                    <h5>Ładuję fiszki...</h5>
                </div>
            </div>

            <!-- Empty State -->
            <div class="card mb-4 d-none" id="emptyState">
                <div class="card-body text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                    <h4 class="mt-3">Brak fiszek</h4>
                    <p class="text-muted">Nie masz jeszcze żadnych fiszek. Dodaj pierwszą!</p>
                    <div class="mt-4">
                        <a href="{{ path('flashcards_generate') }}" class="btn btn-primary me-2">
                            <i class="bi bi-magic"></i> Generuj z AI
                        </a>
                        <a href="{{ path('flashcards_add') }}" class="btn btn-outline-primary">
                            <i class="bi bi-plus-circle"></i> Dodaj ręcznie
                        </a>
                    </div>
                </div>
            </div>

            <!-- Error Alert -->
            <div class="alert alert-danger d-none" id="errorAlert" role="alert">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Błąd!</strong> <span id="errorMessage"></span>
            </div>

            <!-- Flashcards List -->
            <div id="flashcardsContainer" class="d-none">
                <!-- Stats -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <h3 class="text-primary mb-0" id="totalCount">0</h3>
                                <small class="text-muted">Wszystkich fiszek</small>
                            </div>
                            <div class="col-md-4">
                                <h3 class="text-info mb-0" id="aiCount">0</h3>
                                <small class="text-muted">Wygenerowanych AI</small>
                            </div>
                            <div class="col-md-4">
                                <h3 class="text-success mb-0" id="manualCount">0</h3>
                                <small class="text-muted">Dodanych ręcznie</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Flashcards Grid -->
                <div id="flashcardsList" class="row g-3">
                    <!-- Flashcards will be inserted here -->
                </div>

                <!-- Pagination -->
                <nav aria-label="Pagination" class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination will be inserted here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil"></i> Edytuj fiszkę
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editFlashcardId">
                <div class="mb-3">
                    <label for="editQuestion" class="form-label">Pytanie</label>
                    <textarea class="form-control" id="editQuestion" rows="3" required></textarea>
                </div>
                <div class="mb-3">
                    <label for="editAnswer" class="form-label">Odpowiedź</label>
                    <textarea class="form-control" id="editAnswer" rows="3" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn">
                    <i class="bi bi-save"></i> Zapisz
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
    // Save JWT token
    {% if jwt_token is defined %}
        window.JWTAuth.setToken('{{ jwt_token }}');
    {% endif %}

    let currentPage = 1;
    let flashcardsData = [];
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));

    // Load flashcards
    async function loadFlashcards(page = 1) {
        const loadingCard = document.getElementById('loadingCard');
        const errorAlert = document.getElementById('errorAlert');
        const emptyState = document.getElementById('emptyState');
        const flashcardsContainer = document.getElementById('flashcardsContainer');

        loadingCard.classList.remove('d-none');
        errorAlert.classList.add('d-none');
        emptyState.classList.add('d-none');
        flashcardsContainer.classList.add('d-none');

        try {
            const token = window.JWTAuth.getToken();
            const response = await fetch(`/api/flashcards?page=${page}&limit=12`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Błąd podczas ładowania fiszek');
            }

            flashcardsData = data.data;
            currentPage = page;

            if (flashcardsData.length === 0 && page === 1) {
                emptyState.classList.remove('d-none');
            } else {
                renderFlashcards(data);
                flashcardsContainer.classList.remove('d-none');
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('errorMessage').textContent = error.message;
            errorAlert.classList.remove('d-none');
        } finally {
            loadingCard.classList.add('d-none');
        }
    }

    // Render flashcards
    function renderFlashcards(data) {
        const list = document.getElementById('flashcardsList');
        list.innerHTML = '';

        // Update stats
        document.getElementById('totalCount').textContent = data.pagination.total;
        const aiCount = data.data.filter(f => f.source === 'ai').length;
        const manualCount = data.data.filter(f => f.source === 'manual').length;
        document.getElementById('aiCount').textContent = aiCount;
        document.getElementById('manualCount').textContent = manualCount;

        // Render flashcards
        data.data.forEach(flashcard => {
            const col = document.createElement('div');
            col.className = 'col-md-6';
            
            const sourceColor = flashcard.source === 'ai' ? 'info' : 'success';
            const sourceIcon = flashcard.source === 'ai' ? 'magic' : 'pencil';
            
            col.innerHTML = `
                <div class="flashcard-item card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <span class="badge bg-${sourceColor} badge-source">
                                <i class="bi bi-${sourceIcon}"></i> ${flashcard.source === 'ai' ? 'AI' : 'Ręczna'}
                            </span>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editFlashcard(${flashcard.id})" title="Edytuj">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteFlashcard(${flashcard.id})" title="Usuń">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flashcard-front mb-3">
                            <div class="text-muted small mb-1">
                                <i class="bi bi-question-circle"></i> Pytanie:
                            </div>
                            <div class="fw-semibold">${escapeHtml(flashcard.question)}</div>
                        </div>
                        <div class="flashcard-back">
                            <div class="text-muted small mb-1">
                                <i class="bi bi-check-circle"></i> Odpowiedź:
                            </div>
                            <div>${escapeHtml(flashcard.answer)}</div>
                        </div>
                        <div class="mt-3 text-muted small">
                            <i class="bi bi-clock"></i> ${formatDate(flashcard.createdAt)}
                        </div>
                    </div>
                </div>
            `;
            
            list.appendChild(col);
        });

        // Render pagination
        renderPagination(data.pagination);
    }

    // Render pagination
    function renderPagination(pagination) {
        const paginationEl = document.getElementById('pagination');
        paginationEl.innerHTML = '';

        if (pagination.pages <= 1) return;

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${pagination.page === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `
            <a class="page-link" href="#" onclick="changePage(${pagination.page - 1}); return false;">
                <i class="bi bi-chevron-left"></i>
            </a>
        `;
        paginationEl.appendChild(prevLi);

        // Page numbers
        for (let i = 1; i <= pagination.pages; i++) {
            if (i === 1 || i === pagination.pages || (i >= pagination.page - 2 && i <= pagination.page + 2)) {
                const li = document.createElement('li');
                li.className = `page-item ${i === pagination.page ? 'active' : ''}`;
                li.innerHTML = `
                    <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                `;
                paginationEl.appendChild(li);
            } else if (i === pagination.page - 3 || i === pagination.page + 3) {
                const li = document.createElement('li');
                li.className = 'page-item disabled';
                li.innerHTML = '<span class="page-link">...</span>';
                paginationEl.appendChild(li);
            }
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${pagination.page === pagination.pages ? 'disabled' : ''}`;
        nextLi.innerHTML = `
            <a class="page-link" href="#" onclick="changePage(${pagination.page + 1}); return false;">
                <i class="bi bi-chevron-right"></i>
            </a>
        `;
        paginationEl.appendChild(nextLi);
    }

    // Change page
    function changePage(page) {
        loadFlashcards(page);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Edit flashcard
    async function editFlashcard(id) {
        try {
            const token = window.JWTAuth.getToken();
            const response = await fetch(`/api/flashcards/${id}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const flashcard = await response.json();

            if (!response.ok) {
                throw new Error(flashcard.error || 'Błąd podczas ładowania fiszki');
            }

            document.getElementById('editFlashcardId').value = flashcard.id;
            document.getElementById('editQuestion').value = flashcard.question;
            document.getElementById('editAnswer').value = flashcard.answer;

            editModal.show();
        } catch (error) {
            alert('Błąd: ' + error.message);
        }
    }

    // Save edited flashcard
    document.getElementById('saveEditBtn').addEventListener('click', async function() {
        const id = document.getElementById('editFlashcardId').value;
        const question = document.getElementById('editQuestion').value.trim();
        const answer = document.getElementById('editAnswer').value.trim();

        if (!question || !answer) {
            alert('Pytanie i odpowiedź nie mogą być puste');
            return;
        }

        try {
            const token = window.JWTAuth.getToken();
            const response = await fetch(`/api/flashcards/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ question, answer })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Błąd podczas zapisywania');
            }

            editModal.hide();
            loadFlashcards(currentPage);
        } catch (error) {
            alert('Błąd: ' + error.message);
        }
    });

    // Delete flashcard
    async function deleteFlashcard(id) {
        if (!confirm('Czy na pewno chcesz usunąć tę fiszkę?')) {
            return;
        }

        try {
            const token = window.JWTAuth.getToken();
            const response = await fetch(`/api/flashcards/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Błąd podczas usuwania');
            }

            loadFlashcards(currentPage);
        } catch (error) {
            alert('Błąd: ' + error.message);
        }
    }

    // Helper functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('pl-PL', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Load flashcards on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadFlashcards(1);
    });
</script>
{% endblock %}

